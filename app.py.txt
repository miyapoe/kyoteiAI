import streamlit as st
import pandas as pd
import pickle

@st.cache(allow_output_mutation=True)
def load_models():
    try:
        m1 = pickle.load(open("model1.pkl", "rb"))
        m2 = pickle.load(open("model2.pkl", "rb"))
        m3 = pickle.load(open("model3.pkl", "rb"))
        return m1, m2, m3
    except:
        return None, None, None

model1, model2, model3 = load_models()

st.title("ğŸš¤ AIä¸‰é€£å˜ æœŸå¾…å€¤äºˆæ¸¬ã‚¢ãƒ—ãƒª")

jcd = st.text_input("å ´ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: 20ï¼‰", "")
rno = st.text_input("ãƒ¬ãƒ¼ã‚¹ç•ªå·ï¼ˆä¾‹: 1ï¼‰", "")
hd = st.text_input("é–‹å‚¬æ—¥ï¼ˆYYYYMMDDï¼‰", "")
top_n = st.slider("ä¸Šä½ä½•ä»¶ã‚’è¡¨ç¤ºï¼Ÿ", 5, 50, 10)

if st.button("äºˆæ¸¬ã™ã‚‹ï¼"):
    if not (jcd and rno and hd):
        st.error("å ´ã‚³ãƒ¼ãƒ‰ã€ãƒ¬ãƒ¼ã‚¹ç•ªå·ã€é–‹å‚¬æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
    else:
        if model1 is None:
            st.error("ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚")
        else:
            from utils import predict_trifecta_with_expected_value
            try:
                df = predict_trifecta_with_expected_value(
                    jcd=jcd, rno=int(rno), hd=hd,
                    model1=model1, model2=model2, model3=model3,
                    top_n=top_n
                )
                st.dataframe(df)
            except Exception as e:
                st.error(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n{e}")